<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>点击事件诊断 - 轻游空间</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        .test-container {
            margin: 20px;
            padding: 20px;
            border: 2px dashed #ccc;
            background: #f9f9f9;
        }
        .diagnostic-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
    </style>
</head>
<body>
    <div class="container mx-auto p-8">
        <h1 class="text-3xl font-bold mb-8">游戏卡片点击事件诊断</h1>
        
        <!-- 诊断结果显示区域 -->
        <div id="diagnostic-results" class="mb-8">
            <h2 class="text-xl font-semibold mb-4">诊断结果</h2>
        </div>
        
        <!-- 测试区域1：使用generateGameCard生成的卡片 -->
        <div class="test-container">
            <h3 class="text-lg font-semibold mb-4">测试1：动态生成的游戏卡片</h3>
            <div id="dynamic-cards" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- 动态生成的卡片将放在这里 -->
            </div>
        </div>
        
        <!-- 测试区域2：手工HTML卡片 -->
        <div class="test-container">
            <h3 class="text-lg font-semibold mb-4">测试2：手工编写的游戏卡片</h3>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="game-card bg-white rounded-xl shadow-lg overflow-hidden" data-game-id="tetris">
                    <div class="game-image relative">
                        <img src="assets/games/tetris/cover.jpg" alt="俄罗斯方块" class="w-full h-48 object-cover">
                    </div>
                    <div class="game-info p-5">
                        <h3 class="game-title text-lg font-semibold text-gray-900 mb-2">俄罗斯方块</h3>
                        <p class="game-description text-sm text-gray-600 mb-4">经典的方块消除游戏</p>
                        <button class="play-btn w-full bg-blue-500 hover:bg-blue-600 text-white font-medium py-3 px-6 rounded-lg" 
                                data-action="play" data-game-id="tetris">
                            开始游戏
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 测试区域3：简单按钮测试 -->
        <div class="test-container">
            <h3 class="text-lg font-semibold mb-4">测试3：简单按钮测试</h3>
            <button id="simple-test-btn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded mr-4" 
                    data-action="play" data-game-id="tetris">
                简单测试按钮 (data-action)
            </button>
            <button id="onclick-test-btn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded mr-4" 
                    onclick="testDirectClick()">
                onclick测试按钮
            </button>
            <button id="manual-listener-btn" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded">
                手动监听器按钮
            </button>
        </div>
    </div>

    <!-- 加载main.js -->
    <script src="js/main.js"></script>
    
    <script>
        // 诊断函数
        function addDiagnostic(message, type = 'info') {
            const resultsDiv = document.getElementById('diagnostic-results');
            const div = document.createElement('div');
            div.className = `diagnostic-result ${type}`;
            div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            resultsDiv.appendChild(div);
            console.log(`诊断: ${message}`);
        }
        
        // onclick测试函数
        function testDirectClick() {
            addDiagnostic('onclick事件触发成功!', 'success');
            alert('onclick测试成功!');
        }
        
        // 页面加载完成后的诊断
        document.addEventListener('DOMContentLoaded', function() {
            addDiagnostic('DOM加载完成', 'info');
            
            // 等待一下让main.js也加载完成
            setTimeout(runDiagnostics, 1000);
        });
        
        function runDiagnostics() {
            addDiagnostic('开始运行诊断...', 'info');
            
            // 1. 检查关键函数是否存在
            const functions = ['allGames', 'generateGameCard', 'startGame'];
            functions.forEach(func => {
                if (typeof window[func] !== 'undefined') {
                    addDiagnostic(`✅ ${func} 存在`, 'success');
                } else {
                    addDiagnostic(`❌ ${func} 不存在`, 'error');
                }
            });
            
            // 2. 检查游戏数据
            if (typeof allGames !== 'undefined' && allGames.length > 0) {
                addDiagnostic(`✅ 游戏数据加载成功，共 ${allGames.length} 个游戏`, 'success');
            } else {
                addDiagnostic('❌ 游戏数据未加载', 'error');
            }
            
            // 3. 生成动态卡片
            if (typeof generateGameCard === 'function' && typeof allGames !== 'undefined') {
                try {
                    const container = document.getElementById('dynamic-cards');
                    const gameCard = generateGameCard(allGames[0]); // 使用第一个游戏
                    container.innerHTML = gameCard;
                    addDiagnostic('✅ 动态游戏卡片生成成功', 'success');
                } catch (error) {
                    addDiagnostic(`❌ 动态游戏卡片生成失败: ${error.message}`, 'error');
                }
            }
            
            // 4. 检查事件委托
            setTimeout(() => {
                testEventDelegation();
            }, 500);
            
            // 5. 添加手动监听器到最后一个按钮
            const manualBtn = document.getElementById('manual-listener-btn');
            if (manualBtn) {
                manualBtn.addEventListener('click', function() {
                    addDiagnostic('✅ 手动addEventListener事件触发成功!', 'success');
                    alert('手动监听器测试成功!');
                });
                addDiagnostic('✅ 手动监听器添加成功', 'success');
            }
        }
        
        function testEventDelegation() {
            addDiagnostic('测试事件委托...', 'info');
            
            // 查找所有有data-action属性的按钮
            const actionButtons = document.querySelectorAll('[data-action]');
            addDiagnostic(`找到 ${actionButtons.length} 个带有data-action的按钮`, 'info');
            
            // 模拟点击测试
            actionButtons.forEach((btn, index) => {
                const action = btn.dataset.action;
                const gameId = btn.dataset.gameId;
                addDiagnostic(`按钮${index + 1}: action="${action}", gameId="${gameId}"`, 'info');
            });
            
            // 检查是否有document级别的点击监听器
            addDiagnostic('手动触发点击事件测试...', 'info');
            
            // 给第一个按钮添加一个测试监听器来验证事件是否正确冒泡
            if (actionButtons.length > 0) {
                const firstBtn = actionButtons[0];
                firstBtn.addEventListener('click', function(e) {
                    addDiagnostic(`✅ 按钮直接点击监听器触发: ${e.target.tagName}`, 'success');
                });
            }
        }
        
        // 手动测试startGame函数
        function manualTestStartGame() {
            if (typeof startGame === 'function') {
                addDiagnostic('手动调用startGame("tetris")...', 'info');
                try {
                    startGame('tetris');
                    addDiagnostic('✅ startGame函数调用成功', 'success');
                } catch (error) {
                    addDiagnostic(`❌ startGame函数调用失败: ${error.message}`, 'error');
                }
            } else {
                addDiagnostic('❌ startGame函数不存在', 'error');
            }
        }
        
        // 添加一个测试按钮
        setTimeout(() => {
            const container = document.querySelector('.container');
            const testDiv = document.createElement('div');
            testDiv.className = 'test-container';
            testDiv.innerHTML = `
                <h3 class="text-lg font-semibold mb-4">测试4：手动调用</h3>
                <button onclick="manualTestStartGame()" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded">
                    手动调用startGame函数
                </button>
            `;
            container.appendChild(testDiv);
        }, 2000);
    </script>
</body>
</html> 